{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="justify-content-center">
  <div class="container">
    {% if messages %}
    <div class="row">
      {% for message in messages %}
      <div class="message">
        {{ message }}
        <button type="button" onclick="this.parentElement.style.display='none'" class="message">âœ–</button>
      </div>
      {% endfor %}
    </div>
    {% endif %}
  </div>
  <div class="d-flex justify-content-center">
    <div class="flex-fill col-10 m-2 full-note" id="pdf-panel">
      <iframe id="pdf" name="pdf" title="pdf" class="full-note border rounded"></iframe>
    </div>
    <div class="flex-fill col-6 m-2" id="note-panel">
      <textarea type="text" class="full-note container-fluid border rounded" id="note" name="note"
        placeholder="Note">{{ paper.note|safe }}</textarea>
    </div>
    <div class="flex-fill col-6 m-2" id="markdown-panel">
      <div id="markdown" class="border rounded markdown p-2"></div>
    </div>
  </div>
  <div class="col-12 text-center">
    <select id="view-mode" title="View Mode" class="form-control inline" onchange="onViewMode()">
      <option>PDF</option>
      <option>Note</option>
      <option>Markdown</option>
      <option>PDF + Note</option>
      <option>PDF + Markdown</option>
      <option selected>Note + Markdown</option>
    </select>
    <button type="button" class="btn btn-secondary mx-2" onclick='onImportPDF("{{ paper.pdf_url }}")'>Import
      PDF</button>
    <button type="button" class="btn btn-success mx-2" onclick='summarizeBOT()'>Summarize</button>
    <button type="button" class="btn btn-warning mx-2" onclick='translateBOT()'>Translate</button>
    <button type="button" class="btn btn-primary mx-2" onclick='onSave()'>Save</button>
  </div>
</div>
<script>
  const noteControl = document.getElementById('note');
  const markdownControl = document.getElementById('markdown');
  const pdfPanel = $("#pdf-panel");
  const notePanel = $("#note-panel");
  const markdownPanel = $("#markdown-panel");
  const model = "deepseek-r1:32b";
  const llmUrl = "http://10.254.233.67:11434/api/generate";
  var simplemde = new SimpleMDE({
    element: noteControl,
    status: false,
    spellChecker: false,
  });

  simplemde.codemirror.on("change", () => {
    updateMarkdown();
  });

  // noteControl.addEventListener('input', () => {
  //   updateMarkdown();
  // });

  function onLeftButton() {
    if (!markdownPanel.is(":visible")) {
      markdownPanel.show();
      return;
    }

    if (notePanel.is(":visible"))
      notePanel.hide();
  }

  function onViewMode() {
    const selection = document.getElementById("view-mode").value;

    if (selection == 'PDF') {
      pdfPanel.show();
      notePanel.hide();
      markdownPanel.hide();
    } else if (selection == 'Note') {
      pdfPanel.hide();
      notePanel.show();
      markdownPanel.hide();
    } else if (selection == 'Markdown') {
      pdfPanel.hide();
      notePanel.hide();
      markdownPanel.show();
    } else if (selection == 'PDF + Note') {
      pdfPanel.show();
      notePanel.show();
      markdownPanel.hide();
    } else if (selection == 'PDF + Markdown') {
      pdfPanel.show();
      notePanel.hide();
      markdownPanel.show();
    } else if (selection == 'Note + Markdown') {
      pdfPanel.hide();
      notePanel.show();
      markdownPanel.show();
    }
  }

  function updateMarkdown() {
    // let markdown = noteControl.value;
    let markdown = simplemde.value();
    markdown = marked(markdown);

    const regex = /[\p{Script=Han}\p{Script=Hiragana}\p{Script=Katakana}\p{Script=Cyrillic}\p{Script=Devanagari}]/gu;
    markdown = markdown.replace(regex, match => `<span style="color: red;">${match}</span>`);
    markdownControl.innerHTML = markdown;
  }

  async function onImportPDF(pdfUrl) {
    try {
      // noteControl.value = await extractPDF(pdfUrl) + '\n\n---\n\n' + noteControl.value;
      simplemde.value(await extractPDF(pdfUrl) + '\n\n---\n\n' + simplemde.value());
      updateMarkdown();
    } catch (e) {
      alert("Error: " + e.message);
    }
  }

  async function requestBOT(question) {
    try {
      const response = await fetch(llmUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          model: model,
          prompt: question,
          stream: false
        })
      });

      if (!response.ok) {
        throw new Error(`HTTP Error: ${response.status} ${response.statusText}`);
      }

      const data = await response.json();

      if (!data.response) {
        throw new Error("Error: No response received from API.");
      }

      // noteControl.value = data.response.replace(/<think>[\s\S]*?<\/think>/g, '').trim() + '\n\n---\n\n' + noteControl.value;
      simplemde.value(data.response.replace(/<think>[\s\S]*?<\/think>/g, '').trim() + '\n\n---\n\n' + simplemde.value());
      updateMarkdown();
    } catch (e) {
      alert("Error: " + e.message);
      console.error(e);
    }
  }

  async function summarizeBOT() {
    const prompt = "Write a very detailed analysis report for the following paper in Markdown format using bullet points."
    // const question = prompt + "\n\n---\n\nPAPER: " + noteControl.value.trim();
    const question = prompt + "\n\n---\n\nPAPER: " + simplemde.value().trim();

    alert("Sending request!\nIt may take a while to receive a response.");
    requestBOT(question);
  }

  async function translateBOT() {
    const prompt = "Translate the following text into Korean. Do not use Chinese nor Japanese.";
    // const question = prompt + "\n\n---\n\nTEXT: " + noteControl.value.trim();
    const question = prompt + "\n\n---\n\nTEXT: " + simplemde.value().trim();

    alert("Sending request!\nIt may take a while to receive a response.");
    requestBOT(question);
  }

  async function onSave() {
    $.ajax({
      url: "{% url 'paper_update_note' paper.id %}",
      type: "POST",
      data: {
        // note: noteControl.value,
        note: simplemde.value(),
        csrfmiddlewaretoken: "{{ csrf_token }}"
      },
      success: function (response) {
        alert("Note saved successfully!");
      },
      error: function (xhr, msg, err) {
        alert("Error: " + msg);
        console.error(err);
      }
    });
  }

  window.onload = function () {
    pdfPanel.hide();
    updateMarkdown();

    const pdfUrl = "{{ paper.pdf_url }}";
    const frame = document.getElementById('pdf');
    frame.src = pdfUrl;
  }
</script>
{% endblock %}