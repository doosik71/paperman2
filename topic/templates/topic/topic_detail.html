{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="d-flex justify-content-center">
  <div class="col-12">
    <form id="topic-form" method="POST">
      {% csrf_token %}
      <div class="container-xxl my-2">
        <div class="row my-2">
          <div class="col-1">
            <label for="title" class="form-label mt-1">Title</label>
          </div>
          <div class="col-4">
            <input type="text" class="form-control" id="title" name="title" placeholder="Title" required
              value="{{ topic.title }}">
          </div>
          <div class="col-1">
            <label for="keywords" class="form-label mt-1 text-right">Keywords</label>
          </div>
          <div class="col-4">
            <input type="text" class="form-control" id="keywords" name="keywords" placeholder="Keywords"
              value="{{ topic.keywords }}" required>
          </div>
          <div class="col-1">
            <button type="button" class="btn btn-primary mx-2"
              onclick="setFormAction('{% url 'topic_update' topic.id %}')">Update</button>
          </div>
          <div class="col-1">
            <button type="button" class="btn btn-danger mx-2"
              onclick="setFormAction('{% url 'topic_delete' topic.id %}')">Delete</button>
          </div>
        </div>
      </div>
    </form>
    <div class="container-xxl my-3 mx-auto text-center">
      <label for="max_results" class="form-label mt-1"># of Results:</label>
      <select id="max_results" name="max_results">
        <option value="100">100</option>
        <option value="200">200</option>
        <option value="300">300</option>
        <option value="500">500</option>
        <option value="1000">1,000</option>
        <option value="2000">2,000</option>
        <option value="3000">3,000</option>
        <option value="5000">5,000</option>
      </select>
      <button type="button" class="btn btn-success mx-2" onclick="onCollectArxiv()">Collect Arxiv</button>
      <label for="max_results" class="form-label mt-1">Tag filter:</label>
      <button type="button" class="transparent" onclick="onTagFilter('papers', 'üóô')">üóô</button>
      <button type="button" class="transparent" onclick="onTagFilter('papers', 'üìå')">üìå</button>
      <button type="button" class="transparent" onclick="onTagFilter('papers', 'üîé')">üîé</button>
      <button type="button" class="transparent" onclick="onTagFilter('papers', 'üìñ')">üìñ</button>
      <button type="button" class="transparent" onclick="onTagFilter('papers', 'üëç')">üëç</button>
      <button type="button" class="transparent" onclick="onTagFilter('papers', '‚≠ê')">‚≠ê</button>
      <button type="button" class="transparent" onclick="onTagFilter('papers', '‚úÖ')">‚úÖ</button>
    </div>

    <div class="px-3 mx-auto">
      <table id="papers" class="table table-bordered table-hover">
        <thead>
          <tr>
            <th class="text-center">Tags</th>
            <th class="text-center" width="20%">Author</th>
            <th class="text-center" width="50%">Title</th>
            <th class="text-center" width="10%">Publisher</th>
            <th class="text-center">Date</th>
            <th class="text-center">Citations</th>
            <th class="text-center">PDF</th>
          </tr>
        </thead>
        <tbody>
          {% for paper in papers %}
          <tr>
            <td name="tags">
              <div class="smaller text-center" id="tag-{{ paper.id }}"></div>
              <script>
                renderTags({{ paper.id }}, '{{ paper.tags|escapejs  }}')
              </script>
            </td>
            <td name="author">{{ paper.author }}</td>
            <td name="title"><a href="{% url 'paper_detail' paper.id %}"">{{ paper.title }}</a></td>
            <td name="publisher" class=" text-center"><a href="{{ paper.url }}">{{ paper.publisher }}</a></td>
            <td name="publish_date" class="text-center">{{ paper.publish_date|date:"Y.m.d"|default:"N/A" }}</td>
            <td name="citations" class="text-end">{{ paper.citations }} <button class="circle"
                onclick="onCitation(${paper_id})">&#8634;</button></td>
            <td name="pdf_url" class="text-center"><a href="{{ paper.pdf_url }}" title="{{ paper.pdf_url }}">
                <img src="{% static 'images/pdf.png' %}" class="icon" alt="{{ paper.pdf_url }}"></a></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <ol>
    </ol>
  </div>
</div>
<script>
  function setFormAction(actionUrl) {
    var form = document.getElementById('topic-form');
    var title = document.getElementById('title').value;
    var keywords = document.getElementById('keywords').value;

    if (title.trim() === "" || keywords.trim() === "") {
      alert("Title and Keywords are required!");
      return;
    }

    form.action = actionUrl;
    form.submit();
  }

  async function onCollectArxiv() {
    const topic_id = "{{ topic.id }}";
    const keywords = document.getElementById('keywords').value;
    const post_url = "{% url 'paper_add' %}";
    const csrf_token = "{{ csrf_token }}";
    const max_results = document.getElementById('max_results').value;

    const count = await collectArxiv(topic_id, keywords, max_results, post_url, csrf_token);

    alert(`Collected ${new Intl.NumberFormat().format(count)} papers`);
  }

  function onCollectScholar() {
    const topic_id = "{{ topic.id }}";
    const keywords = document.getElementById('keywords').value;
    const post_url = "{% url 'paper_add' %}";
    const csrf_token = "{{ csrf_token }}";

    collectArxiv(topic_id, keywords, 30, post_url, csrf_token)
  }

  function onToggleTag(paper_id, tag) {
    const post_url = "{% url 'paper_tag' %}";
    const csrf_token = "{{ csrf_token }}";

    toggleTag(paper_id, tag, post_url, csrf_token);
    
    // if (success) {
    //   tags = 
    //   renderTags(paper_id, tag);
    // }
  }

  $(document).ready(function () {
    $('#papers').DataTable({
      "pageLength": 100
    });
  });
</script>
{% endblock %}